### 链路层

#### 环回接口

一个传给环回接口的数据报不能在任何网络上出现。只是当IP数据报离开网络层时把它返回给自己。

1. 传给环回地址（127.0.0.1）的任何数据均作为IP输入。
2. 传给广播地址或多播地址的数据报复制一份传给环回接口。
3. 任何传给该主机IP地址的数据均送到环回接口。

看上去用传输层和IP层的方法处理环回数据似乎效率不高，但它简化了设计，因为环回接口可以被看作是网络层下面的另外一个链路层。网络层把一份数据报传送给环回接口，就像传给其他链路层一样，只不过环回接口把它返回到IP的输入队列中。

### IP ：网际协议

所有的TCP,UDP,ICMP及IGMP数据都以IP数据包格式传输。

**IP数据报是无连接的，IP数据报可以不按发送顺序接收。**如果一信源向相同的信宿发送两个连续的数据报，每个数据报都是独立地进行路由选择，可能选择不同的路线，因此B可能在A到达之前先到达。

#### IP首部

##### 标识字段

标识字段唯一地标识主机发送的每一份数据报。

##### 首部校验和字段

首部校验和字段是根据IP首部计算的校验和码。它不对首部后面的数据进行计算。ICMP,IGMP,UDP和TCP在它们各自的首部中均含有同时覆盖首部和数据校验和码。

###### 校验和计算方式

每16bit进行二进制反码求和。结果存在校验和字段，当收到一份IP数据报后，同样对每16bit进行二进制反码求和。由于接收方在计算过程中包含了发送方存在首部中的检验和，因为，如果在传输过程中没有发生任何差错，那么接收方计算的结果应该为全1。**如果结果不全是1，那么IP就丢弃收到的数据报。但是不生成差错报文，由上层去发现丢失的数据报并进行重传**

### UDP ：用户数据报协议

#### UDP首部

##### UDP校验和

UDP校验和覆盖UDP首部和UDP数据。同想IP首部的校验和，它只覆盖IP的首部。

UDP的检验和是可选的，而TCP的检验和是必需的。

如果检验和的计算结果为0，则存入的值为全1（65535）,这在二进制反码计算中是等效的，如果传送的检验和为0，说明发送端没有计算校验和。

##### UDP伪首部？？？

UDP数据报和TCP段都包含一个12字节的伪首部，它是为了计算检验和而设置的。伪首部包含了IP首部的一些字段。其目的是让UDP两次检查数据是否已经正确地到达目的地。（例如，IP没有接受地址不是本主机的数据报，以及IP没有把应传给另一高层的数据报传给UDP。）

#### IP分片

分片可以发生在原始发送端主机上，也可以发生在中间路由器上。把一份IP数据报分片以后，只有到达目的地才进行重新组装，重新组装由目的端的IP层来完成，其目的是使分片和重新组装过程对传输层是透明的。

**即使只丢失一片数据，也要重传整个数据报。因为IP层本身没有超时重传的机制。**

在分片中，除最后一片外，其他每一片中的数据部分（除IP首部外的其余部分）必须是8字节的整数倍。

###### 术语

IP数据报是指IP层端到端的传输单元（在分片之前和重新组装之后），分组是指IP层和链路层之间的传送的数据单元。一个分组可以是一个完整的IP数据报也可以是IP数据报的一个分片。

### TCP : 传输控制协议

##### TCP通过下列方式来提供可靠性

1. 应用数据被分割成TCP认为最适合发送的数据块。
2. 当TCP发出一个段后，它启动一个定时器，等待目的端确认收到这个报文段。如果不能及时收到一个确认，将重发这个报文段。
3. 当TCP收到发自TCP连接另一端的数据，它将发送一个确认。
4. TCP将保持它首部和数据的校验和。
5. 既然TCP报文段作为IP数据报来传输，而IP数据报的到达可能会失序，因此TCP报文段的到达也可能会失序。如果必要，TCP将对收到的报文进行重新排序，将收到的数据以正确的顺序交给应用层。
6. 既然IP数据报会发生重复，TCP的接收端必须丢弃重复的数据。
7. TCP还能进行流量控制。

#### TCP首部

##### 序列号

SYN和FIN标志消耗一个序列号

发送ACK无需任何代价，因为32bit的确认序号字段和ACK标志一样，总是TCP首部的一部分。因此，我们看到一旦一个连接建立起来，这个字段总是被设置，ACK标志也总是被设置为1.

**如果收到包含1025-2048字节的报文段，但它的检验和错，TCP接收端所能做的就是发回一个确认序号为1025的ACK**

##### 可选字段MSS

最常见的可选字段是最长报文大小，又称为MSS。每个连接方通常都在通信的第一个报文段（为建立连接而设置SYN标志的那个段）中指明这个选项。（MSS选项只能出现在SYN报文段中）。

报文段越大允许传送的数据就越多，相对IP和TCP首部有更高的网络利用率。

### TCP连接的建立与终止

### TCP的交互数据流

##### 经受时延的确认

通常TCP在接收到数据时并不立即发送ACK;相反，它推迟发送，以便将ACK与需要沿该方向发送的数据一起发送（有时候称这种现象为数据捎带ACK）。绝大多数实现采用的时延为200ms，也就是说，TCP将以最大200ms的时延等待是否又数据一起发送。

##### Nagle算法

该算法要求一个TCP连接上最多只能又有一个未被确认的未完成的小分组，在该分组的确认到达之前不能发送其他的小分组。相反，TCP收集这些少量的分组，并在确认到来时以一个分组的方式发送出去。

该算法的优越之处在于它是自适应的；确认到达得越快，数据也就发送得越快。

###### 关闭Nagle算法

有时我们也需要关闭Nagle算法。一个典型的例子是X窗口系统服务器，小消息（鼠标移动）必须无时延的发送，以便为进行某种操作的交互用户提供实时的反馈。

### TCP的成块数据流

使用TCP的滑动窗口协议时，接收方不必确认每一个收到的分组。在TCP中，ACK是累积的，它们表示接收方已经正确收到了一直到确认序号减1的所有字节。

###### 用作窗口更新的ACK

ACK可以用于窗口更新，这样的ACK并不确认任何新的数据。

##### Push标志

发送方使用该标志通知接收方将收到的数据全部提交给接收进程。这里的数据包括与push一起传送的数据以及接受方TCP已经为接收进程收到的其他数据。当服务器的TCP接收到一个设置了PUSH标志的报文段时，它需要立即将这些数据递交给服务器进程而不能等待判断是否还会有额外数据的到达。

##### 带宽时延乘积

不论是带宽还是时延均会影响发送方和接收方之间的通路的容量。

TCP为使发送方和接收方之间的管道充满来获得最可能快的传输速度而采用的方法。我们用带宽时延乘积衡量管道的容量，并分析了该乘积与窗口大小之间的关系。

### TCP的超时与重传

TCP通过在发送时设置一个定时器来解决这种问题。如果当定时器溢出时还没有收到确认，它就重传该数据。

##### TCP定时器

对每个连接，TCP管理4个不同的定时器

1. 重传定时器使用于当希望收到另一端的确认。（500ms，重传超时，1.5s，3s,6s,12s,24s,48s,多个64s）
2. 坚持定时器使窗口大小信息保持不断流动，即使另一端关闭了其接收窗口。
3. 保活定时器可检测到一个空闲连接的另一端何时崩溃或重启
4. 2MSL定时器测量一个连接处于TIME_WAIT状态的时间。

##### 超时重传

发送方的TCP放弃重传时，发送一个复位信号。

首次分组传输与复位信号传输之间的时间差约为9分钟。

##### 慢启动和拥塞避免算法

###### 拥塞避免算法和慢启动算法需要对每个连接维持两个变量：一个拥塞窗口cwnd和一个慢启动门限ssthresh.

###### 慢启动

1. 慢启动过程，cwnd一般初始化为1个mss。ssthresh初始化为65535字节。
2. 每收到一个确认的ack，cwnd增加min(本次ack确认的字节数,mss)。
3. 当达到cwnd达到ssthresh时则进入拥塞避免阶段

###### 拥塞避免

cwnd以线性方式增加，在每个往返时间内cwnd最多增加1个mss。

###### 重传定时器超时，发生拥塞，重新进入到慢启动阶段

1. sshthresh设置为cwnd的一半，cwnd重新设置为1个mss大小
2. 进入慢启动阶段

##### 快速重传和快速恢复算法

在收到一个失序的报文段时，TCP立即需要产生一个ACK（一个重复的ack）。这个重复的ack不应该被延滞。

由于我们不知道一个重复的ack是由一个丢失的报文段引起的，还是由于仅仅出现了几个报文段的重新排序，因此我们等待少量重复的ACK到来。假如这只是一些报文段的重新排序，则在重新排序的报文段被处理并产生一个新的ack之前只可能产生1-2个重复的ACK。如果一连串收到3个或3个以上的重复ACK，就非常可能是一个报文段丢失了。

1. 当收到3个重复的ACK时将sshthresh设置为cwnd的一半。重传丢失的报文，设置cwnd为sshthresh+3*mss。
2. 每次收到一个重复的ACK时，cwnd增加一个mss。
3. 当下一个确认新数据的ACK到达时，将cwnd设置为第一步中设置的sshthresh。
4. 然后进入拥塞避免状态。

##### 拥塞检测

1. 重传定时器超时
2. 收到3个重复的ACK

##### 重新分组

当TCP超时并重传时，它不一定要重传同样的报文段。相反，TCP允许进行重新分组而发送一个较大的报文段，这将有助于提高性能（当然，这个较大的报文段不能超过接收方声明的mss）。

###### 拥塞避免是发送方采取的流量控制手段，而接收方通告窗口是接收方进行的流量控制。

### TCP的坚持定时器

TCP通过让接收方指明希望从发送方接收的数据字节数（即窗口大小）来进行流量控制。如何处理通告窗口的ACK，ACK的传输并不可靠，也就是说,TCP不对ACK报文段进行确认，TCP只确认那些包含有数据的ACK的报文段。

##### 坚持定时器

发送方使用一个坚持定时器来周期性地向接收方查询，以便发现窗口是否已经增大，这些从发送方发出的报文段称为窗口探查。

###### 窗口探查时间间隔

5s,5s,6s,12s,24s,48s,60s

**坚持状态与重传超时之间一个不同的特点是TCP从不放弃发送窗口探查。这些探查每隔60s发送一次，找个过程将持续到或者窗口被打开，或者应用进程使用的连接被终止。**

##### 糊涂窗口综合症

该现象可发生在两端中的任何一端，接收方可以通告一个小的窗口（而不是一直等到大的窗口时才通告），而发送方也可以以发送少量的数据。

###### 采取措施

1. 接收方不通告小窗口，除非该窗口可以增加一个mss,或者增加接收方缓存空间的一半。
2. (a).发送方可以发送一个满长度的报文段（b）可以发送至少是通告窗口大小一半的报文段（c)可以发送任何数据并且不希望接受ACK（也就是说我们没有还未被确认的数据）或者该连接上不能使用Nagle算法。

### TCP保活定时器

##### KEEPALIVE

一共发送9个保活探查，间隔为75s,总共11分15秒。





